<h2>Tester l'authentification JWT</h2>
<label for="jwt-username">Nom d'utilisateur :</label>
<input type="text" id="jwt-username" placeholder="Entrez votre nom d'utilisateur" />
<br />
<label for="jwt-password">Mot de passe :</label>
<input type="password" id="jwt-password" placeholder="Entrez votre mot de passe" />
<br />
<button id="generate-jwt">Générer le JWT</button>
<pre id="jwt-display"></pre>
<pre id="jwt-error" style="color: red;"></pre>

<h2>Tester WebSocket avec JWT</h2>
<button id="connect-ws">Se connecter au WebSocket</button>
<pre id="ws-log"></pre>

<h2>Envoyer un message via WebSocket</h2>
<input type="text" id="ws-message" placeholder="Entrez votre message" disabled />
<button id="send-ws-message" disabled>Envoyer</button>

<h2>Inscription</h2>
<a href="/register/">Aller à la page d'inscription</a>

<script>
    let jwtToken = "";
    let ws;

    // Récupérer un vrai JWT
    document.getElementById("generate-jwt").onclick = async () => {
        const username = document.getElementById("jwt-username").value;
        const password = document.getElementById("jwt-password").value;

        if (!username || !password) {
            alert("Veuillez entrer un nom d'utilisateur et un mot de passe.");
            return;
        }

        const response = await fetch('/api/token/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            const data = await response.json();
            jwtToken = data.access;
            document.getElementById("jwt-display").textContent = `JWT: ${jwtToken}`;
            document.getElementById("jwt-error").textContent = "";
            console.log("JWT récupéré:", jwtToken);
        } else {
            const errorData = await response.json();
            document.getElementById("jwt-error").textContent = `Erreur d'authentification : ${errorData.detail || 'Inconnue'}`;
            jwtToken = "";
            console.error("Erreur JWT:", errorData);
        }
    };

    // Se connecter au WebSocket
    document.getElementById("connect-ws").onclick = () => {
        if (!jwtToken) {
            alert("Veuillez générer un JWT avant de vous connecter.");
            return;
        }

        ws = new WebSocket(`ws://localhost:8000/ws/somepath/?token=${jwtToken}`);

        ws.onopen = () => {
            console.log("WebSocket connecté.");
            document.getElementById("ws-log").textContent += "\n[WebSocket] Connecté.";
            document.getElementById("ws-message").disabled = false;
            document.getElementById("send-ws-message").disabled = false;
        };

        ws.onmessage = (event) => {
            console.log("Message reçu:", event.data);
            document.getElementById("ws-log").textContent += `\n[Serveur] ${event.data}`;
        };

        ws.onerror = (error) => {
            console.error("Erreur WebSocket:", error);
            document.getElementById("ws-log").textContent += "\n[Erreur WebSocket]";
        };

        ws.onclose = (event) => {
            console.log("WebSocket déconnecté.");
            let reason = "Déconnecté.";
            if (event.code === 4003) reason = "JWT invalide ou expiré.";
            document.getElementById("ws-log").textContent += `\n[WebSocket] ${reason}`;
            document.getElementById("ws-message").disabled = true;
            document.getElementById("send-ws-message").disabled = true;
        };
    };

    // Envoyer un message via WebSocket
    document.getElementById("send-ws-message").onclick = () => {
        const message = document.getElementById("ws-message").value;
        if (message && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(message);
            console.log("Message envoyé:", message);
            document.getElementById("ws-log").textContent += `\n[Vous] ${message}`;
        } else {
            alert("WebSocket non connecté ou message vide.");
        }
    };
</script>
